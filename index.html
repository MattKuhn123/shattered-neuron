<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shattered Neuron</title>
    <link href="./styles.css" rel="stylesheet" />
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js></script>
    <script src="./formula-output.js"></script>
    <script src="./submit-output-form.js"></script>
</head>

<body>
    <main class="surface surface-dark">
        <form is="submit-output-form" class="center-content">
            <section class="surface surface-light">
                <h2>Scout Report</h2>
                <label for="opponent-victory-points">Opponent Victory points: </label>
                <output id="opponent-victory-points" name="opponent-victory-points" class="input input-dark">0</output>
                <label for="opponent-remaining-forces">Opponent remaining forces: </label>
                <output id="opponent-remaining-forces" name="opponent-remaining-forces"
                    class="input input-dark">1000</output>
                <div id="opponent-activity-container" style="display: none;">
                    <label for="opponent-actions-output">Opponent activity...</label>
                    <output id="opponent-actions-output"><samp id="opponent-actions"></samp></output>
                    <label for="opponent-progress">Opponent progress...</label>
                    <progress id="opponent-progress" max="100" value="0"></progress>
                </div>
            </section>
            <section class="surface surface-light">
                <h2>HQ</h2>
                <label for="player-victory-points">Victory Points: </label>
                <output id="player-victory-points" name="player-victory-points" class="input input-dark">0</output>
                <label for="player-remaining-forces">Remaining forces: </label>
                <output id="player-remaining-forces" name="player-remaining-forces"
                    class="input input-dark">1000</output>
                <fieldset>
                    <legend>Force commitment</legend>
                    <label for="player-commit-forces">Forces: </label>
                    <input id="player-commit-forces" type="number" name="player-commit-forces" class="input input-dark"
                        required max="1" min="1" />
                </fieldset>
                <button class="input input-dark">Commit</button>
            </section>
        </form>
    </main>
    <dialog id="after-action-report" class="">
        <h2>After Action Report</h2>
        <form method="dialog">
            <div style="display: flex; gap: 10px;" class="surface surface-light">
                <table style="flex: 2; border-right: 1px solid var(--accent-color); padding-right: 5px;" class="table table-dark">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Forces</th>
                            <th>Opposition</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Starting forces</td>
                            <td id="report-table-player-starting-forces"></td>
                            <td id="report-table-opponent-starting-forces"></td>
                        </tr>
                        <tr>
                            <td>Commited forces</td>
                            <td id="report-table-player-commited-forces"></td>
                            <td id="report-table-opponent-commited-forces"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><mark id="report-table-outcome-player-perspective"></mark></td>
                        </tr>
                        <tr>
                            <td>Victory points</td>
                            <td id="report-table-player-earned-victory-points"></td>
                            <td id="report-table-opponent-earned-victory-points"></td>
                        </tr>
                        <tr>
                            <td>Remaining forces</td>
                            <td id="report-table-player-remaining-forces"></td>
                            <td id="report-table-opponent-remaining-forces"></td>
                        </tr>
                    </tbody>
                </table>
                <aside style="flex: 1;">
                    Sir,<br>
                    We commited <mark id="report-player-commitment"></mark> forces to the engagement.
                    The opposition commited <mark id="report-opponent-commitment"></mark> forces.
                    We <mark id="report-outcome"></mark> the engagement, and the victor gained <mark
                        id="report-victory-points"></mark> victory points.
                </aside>
            </div>
            <button id="confirm-after-action-report" class="input input-dark">Confirm</button>
        </form>
    </dialog>
</body>
<script>
    elt = (id) => {
        return document.getElementById(id);
    }

    val = (id, value) => {
        const x = elt(id);
        if (!x) throw `Element with id '${id}' not found.`;

        if (value !== undefined) {
            if (x.tagName.toLowerCase() === "input") {
                x.value = value;
            } else {
                x.textContent = value;
            }
        } else {
            if (x.tagName.toLowerCase() === "input") {
                return Number(x.value);
            } else {
                return Number(x.textContent);
            }
        }

    }

    inc = (id, amount = 1) => val(id, val(id) + amount);

    document.addEventListener("DOMContentLoaded", () => doEngagementCycle(engagementCycle()));

    engagementCycle = () => {
        return {
            setUpGameState: async () => {
                const params = new URLSearchParams(window.location.search);
                const isStart = params.size === 0;

                if (!params.has("player-remaining-forces"))
                    params.set("player-remaining-forces", "1000");

                if (!params.has("opponent-remaining-forces"))
                    params.set("opponent-remaining-forces", "1000");

                if (!params.has("player-victory-points"))
                    params.set("player-victory-points", "0");

                if (!params.has("opponent-victory-points"))
                    params.set("opponent-victory-points", "0");

                params.forEach((v, k) => val(k, v));
                return isStart;
            },
            opponentCommitForces: async () => {
                return new Promise((resolve) => {
                    document.getElementById("opponent-activity-container").style = "display: block;";
                    document.getElementById("opponent-progress").value = 0;
                    val("opponent-actions", "Planning...");
                    setTimeout(() => {
                        document.getElementById("opponent-progress").value = 50;
                        val("opponent-actions", "Mobilizing...");
                        setTimeout(async () => {
                            document.getElementById("opponent-progress").value = 100;
                            val("opponent-actions", "");
                            this.opponentForces = Math.floor(Math.random() * val("opponent-remaining-forces"));
                            resolve();
                        }, 500)
                    }, 1000);
                });
            },
            engage: async () => {
                inc("player-remaining-forces", -val("player-commit-forces"));
                inc("opponent-remaining-forces", -this.opponentForces);

                this.victoryPoints = 1;
                this.playerVictory = val("player-commit-forces") > this.opponentForces;
                if (this.playerVictory) {
                    inc("player-victory-points", this.victoryPoints);
                } else {
                    inc("opponent-victory-points", this.victoryPoints);
                }
            },
            afterActionReport: async () => {
                document.getElementById("after-action-report").showModal();
                val("report-player-commitment", val("player-commit-forces"));
                val("report-opponent-commitment", this.opponentForces);
                val("report-outcome", `${this.playerVictory ? "won" : "lost"}`);
                val("report-victory-points", this.victoryPoints);

                val("report-table-player-starting-forces", val("player-remaining-forces") + val("player-commit-forces"));
                val("report-table-opponent-starting-forces", val("opponent-remaining-forces") + this.opponentForces);
                val("report-table-player-commited-forces", val("player-commit-forces"));
                val("report-table-opponent-commited-forces", this.opponentForces);
                val("report-table-player-earned-victory-points", (this.playerVictory ? this.victoryPoints : "0"));
                val("report-table-opponent-earned-victory-points", (this.playerVictory ? "0" : this.victoryPoints));
                val("report-table-player-remaining-forces", val("player-remaining-forces"));
                val("report-table-opponent-remaining-forces", val("opponent-remaining-forces"));
                val("report-table-outcome-player-perspective", this.playerVictory ? "Victory" : "Defeat");

                return new Promise((resolve) => {
                    document.getElementById("after-action-report").addEventListener("close", () => {
                        resolve();
                    }, { once: true });
                });
            },
            checkFinalState: async () => {
                // TODO : Check if the game is over
            },
            setUpPlayerCommitForces: async () => {
                document.getElementById("opponent-progress").value = 0;
                document.getElementById("opponent-activity-container").style = "display: none;";
                val("player-commit-forces", 0);
                elt("player-commit-forces").max = val("player-remaining-forces");
            }
        }
    }

    doEngagementCycle = async (engagementCycle) => {
        document.querySelectorAll("input").forEach(x => x.setAttribute("readonly", true));
        document.querySelectorAll("button").forEach(x => x.setAttribute("disabled", true));
        
        const isStart = await engagementCycle.setUpGameState();
        if (!isStart) {
            await engagementCycle.opponentCommitForces();
            await engagementCycle.engage();
            document.querySelector("#confirm-after-action-report").removeAttribute("disabled");
            await engagementCycle.afterActionReport();
            document.querySelector("#confirm-after-action-report").setAttribute("disabled", true);
        }

        await engagementCycle.checkFinalState();
        await engagementCycle.setUpPlayerCommitForces();

        document.querySelectorAll("input").forEach(x => x.removeAttribute("readonly"));
        document.querySelectorAll("button").forEach(x => x.removeAttribute("disabled"));
    }
</script>

</html>